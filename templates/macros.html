{% macro poly_path(value, assets) %}
  {% set_global path = value %}
  {% if value is not starting_with("/") and assets is defined %}
    {% for asset in assets %}
      {% if asset is ending_with("/"~value) %}
        {% set_global path = asset %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {{ path }}
{% endmacro %}



{% macro background_image_vars(path) %}
{% set image_sm = resize_image(path=path, width=769, height=769, op='fill', format='webp')%}
{% set image_tb = resize_image(path=path, width=769, op='fit_width', format='webp')%}
{% set image_ds = resize_image(path=path, width=960, op='fit_width', format='webp')%}
{% set image_wd = resize_image(path=path, width=1152, op='fit_width', format='webp')%}
{% set image_fd = resize_image(path=path, width=1344, op='fit_width', format='webp')%}
--background-widescreen: url({{image_wd.url}});
--background-fullhd: url({{image_fd.url}});
--background-desktop: url({{image_ds.url}});
--background-tablet: url({{image_tb.url}});
--background-sm: url({{image_sm.url}});
{% endmacro  %}

{% macro debug(value) %} 
<code>
  <pre>
    {{ value | json_encode(pretty=true) }}
  </pre>
</code>
{% endmacro %}


{% macro brand_bar(menu_id=false) %}
<div class="poly-brand">
  <a class="poly-logo-link" href="{{config.base_url}}" {% if config.extra.poly.app_name %} title="{{config.extra.poly.app_name}}" {% endif %}>
    {% if config.extra.poly.logo %}
    <img src="{{get_url(path=config.extra.poly.logo)}}" alt="Logo">
    {% elif config.extra.poly.app_name %}
    <h2>{{config.extra.poly.app_name}}</h2>
    {% else %}
    <h2>Polymathic</h2>
    {% endif %}
  </a>
  {% if menu_id %} 
    <a id="menu-trigger-{{menu_id}}" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="{{menu_id}}">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  {% endif %}
</div>
{% endmacro %}


{% macro content_meta(content) %}
<title>{{ content.title }}{% if config.extra.poly.app_name %} | {{config.extra.poly.app_name}}{% endif %}</title>
<meta name="description" content="{{ content.description }}" />
<meta property="og:title" content="{{ content.title }}" />
<meta property="og:description" content="{{ content.description }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="{{current_url | default(value=config.base_url)}}" />
  {% if content.extra.poly.hero %}
    {% set path = macros::poly_path(value=content.extra.poly.hero, assets=content.assets) | trim %}
    {% set image_meta = get_image_metadata(path=path) %}
    {% if image_meta.height > 630 or image_meta.width > 1200 %} 
      {% set image = resize_image(path=path, width=1200, height=630, op='fill', format='webp') %}
    {% else %}
      {% set side = image_meta.width %}
      {% if image_meta.width > image_meta.height %}
        {% set side = image_meta.height %}
      {% endif %}
      {% set image = resize_image(path=path, width=side, height=side, op='fill', format='webp') %}
    {% endif %}
    <meta
      property="og:image"
      content="{{ image.url | safe }}"
    />
  {% elif config.extra.poly.og_image %}
    <meta
      property="og:image"
      content="{{ get_url(path=config.extra.poly.og_image) | safe }}"
    />
  {% endif %} 
{% endmacro %}

{% macro link_attrs(type=false, href, title=false, current_url=false, class=false) %}
  class="poly-{% if type %}{{type}}-{% endif %}link{% if current_url and current_url == href %} poly-active-link{% endif %}{% if class %} {{class}}{% endif %}"
  href="{{href | safe}}"
  {% if title %}
  title="{{title}}"
  {% endif %}
{% endmacro %}

{% macro link_hero_card(title, path, type, hero=false, description=false, block=false, banner=false, pop=false) %}
  {% set link_class = "" %}
  {% set class_name = "poly-hero-card" %}
  {% if block == true %}
    {% set class_name = "poly-hero-block" %}
    {% set link_class = "poly-block-link" %}
    {% if hero != false %}
      {% set banner = true %}
    {% endif %}
  {% endif %}
  {% if hero != false and banner == true %}
    {% set class_name = class_name~" poly-with-image" %}
  {% endif %}
  {% if pop == true %}
    {% set link_class = link_class~" poly-pop" %}
  {% endif %}
  <a {{macros::link_attrs(type=type, href=path, title=title, current_url=current_path, class=link_class)}}
    {% if hero != false and banner == true %}
    style="{{macros::background_image_vars(path=hero)}}"
    {% endif %}
  >
    <div class="{{class_name}}">
      {% if banner == false and hero != false %} 
        <div class="card-image">
          <figure class="poly-image is-4by3">
            <img {{macros::img_src(
              src=hero, 
              ratio=4.0/3.0,
              breakpoints=["min-width: 769px", "min-width: 960px", "min-width: 1152px"],
              sizes=[200, 400, 600, 900],
            ) }} 
            alt="{{title}}"
            />
          </figure>
        </div>
      {% endif %}
      <div class="poly-content">
        <p class="title is-4 is-subtitle">{{ title }}</p>
        {% if description != false %}
          <p>{{ description }}</p>
        {% endif %}
      </div>
    </div>
  </a>
{% endmacro %}

{% macro img_src(src, sizes, breakpoints, ratio) %}
  sizes="{% for size in sizes %}{% if breakpoints[loop.index0] %}({{breakpoints[loop.index0]}}) {{size}}px,{% else %}{{size}}px{% endif %}{% endfor %}"
  srcset="{% for size in sizes %}{% set image = resize_image(path=src, width=size, height=size / ratio | int, op='fill')%}{{image.url}} {{size}}w{% if loop.last == false%},{% endif %}{% endfor %}"
  src="{{src}}"  
{% endmacro %}

{% macro pager(pagination)%}
  <nav class="poly-pager is-rounded" role="navigation" aria-label="pagination">
    {% if pagination.previous %}
      <a href="{{pagination.previous}}" class="pagination-previous">Previous</a>
    {% endif %}
    {% if pagination.next %}
      <a href="{{pagination.next}}" class="pagination-next">Next page</a>
    {% endif %}
    <ul class="pagination-list">
      {% for pg in range(start=1, end=pagination.number_pagers+1) %}
        <li>
          <a href="{%if pg > 1%}{{pagination.base_url~pg}}{%else%}{{pagination.first}}{%endif%}" class="pagination-link{% if pg == pagination.current_index %} is-current{% endif %}" aria-label="Goto page {{pg}}">
            {{pg}}
          </a>
        </li>
      {% endfor %}
    </ul>
  </nav>
{% endmacro %}

{% macro content_modals(assets) %}
{% for asset in assets %}
  {% if asset is matching(".(png|jpeg|jpg|gif|webp)$")%}
    {% set name = asset | split(pat="/") | last %}
    {% set alt = name | split(pat=".") | first | replace(from="_", to=" ") | title%}
    <div class="modal" id="content-asset-modal-{{name | slugify}}">
      <div class="modal-background"></div>
      <div class="modal-content">
        <figure class="image">
          {% set image_meta = get_image_metadata(path=asset) %}
          <img {{macros::img_src(
            src=asset, 
            ratio=image_meta.width/image_meta.height,
            breakpoints=["min-width: 769px", "min-width: 960px", "min-width: 1152px"],
            sizes=[769, 960, 1152, 1344],
          ) }} 
            alt="{{alt}}"
          />
        </figure>
      </div>
      <button class="modal-close is-large" aria-label="close"></button>
    </div>
  {% endif %}
{% endfor %}
{% endmacro %}

